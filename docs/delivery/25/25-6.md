# Task 25-6: Refactor configuration and crypto modules

**Task ID**: 25-6  
**Parent PBI**: [PBI 25: Unify security-related enums across modules](./prd.md)  
**Status**: Completed

## Overview

Refactor configuration and crypto modules to use unified security types from [`security_types.rs`](../../src/security_types.rs) instead of duplicate enum definitions.

## Objectives

1. **Update Configuration Module**: Refactor [`src/config/crypto.rs`](../../src/config/crypto.rs) to use unified [`SecurityLevel`](../../src/security_types.rs:187) from security_types
2. **Update Enhanced Error Module**: Refactor [`src/crypto/enhanced_error.rs`](../../src/crypto/enhanced_error.rs) to use unified [`Severity`](../../src/security_types.rs:110) from security_types  
3. **Remove Duplicate Definitions**: Eliminate duplicate [`SecurityLevel`](../../src/config/crypto.rs:275) and [`ErrorSeverity`](../../src/crypto/enhanced_error.rs:17) enums
4. **Update All Usage**: Update all references and method implementations throughout these modules
5. **Verify Compilation**: Ensure all changes compile successfully with no breaking changes

## Target Files

### Primary Refactoring Targets
- [`src/config/crypto.rs`](../../src/config/crypto.rs) - Contains duplicate SecurityLevel enum (lines 272-284)
- [`src/crypto/enhanced_error.rs`](../../src/crypto/enhanced_error.rs) - Contains duplicate ErrorSeverity enum (lines 17-26)

### Dependencies to Check
- Any other configuration files that reference the duplicate enums
- Test files that may need updates
- CLI modules that use SecurityLevel

## Key Changes Required

### SecurityLevel Unification
- **Current Duplicate**: `Interactive`, `Balanced`, `Sensitive` in [`src/config/crypto.rs`](../../src/config/crypto.rs:275)
- **Unified Target**: `Low`, `Standard`, `High` in [`src/security_types.rs`](../../src/security_types.rs:187)
- **Mapping Strategy**: Interactive → Low, Balanced → Standard, Sensitive → High

### ErrorSeverity Unification  
- **Current Duplicate**: `Low`, `Medium`, `High`, `Critical` in [`src/crypto/enhanced_error.rs`](../../src/crypto/enhanced_error.rs:17)
- **Unified Target**: `Info`, `Warning`, `Error`, `Critical` in [`src/security_types.rs`](../../src/security_types.rs:110)
- **Mapping Strategy**: Low → Info, Medium → Warning, High → Error, Critical → Critical

## Implementation Plan

### Phase 1: Update Configuration Module
1. Add import for unified [`SecurityLevel`](../../src/security_types.rs:187) from security_types
2. Remove duplicate [`SecurityLevel`](../../src/config/crypto.rs:275) enum definition
3. Update method implementations to use new enum variants
4. Update parameter mapping in [`KeyDerivationConfig`](../../src/config/crypto.rs:149) methods

### Phase 2: Update Enhanced Error Module  
1. Add import for unified [`Severity`](../../src/security_types.rs:110) from security_types
2. Remove duplicate [`ErrorSeverity`](../../src/crypto/enhanced_error.rs:17) enum definition
3. Replace all [`ErrorSeverity`](../../src/crypto/enhanced_error.rs:17) usage with [`Severity`](../../src/security_types.rs:110)
4. Update error constructors and accessor methods

### Phase 3: Verification and Testing
1. Compile with `cargo check` after each module change
2. Run existing tests to verify no functionality regression
3. Update any failing tests to use new enum variants
4. Verify all imports and usage are correctly updated

## Status History

| Date | Status | Notes |
|------|--------|-------|
| 2025-06-13 | InProgress | Task implementation started, updating status from Proposed |
| 2025-06-13 | Completed | Successfully refactored configuration and crypto modules to use unified security types |

## Implementation Notes

### Configuration Module Updates
- **File**: [`src/config/crypto.rs`](../../src/config/crypto.rs)
- **Changes Made**:
  - Added import: `use crate::security_types::SecurityLevel;`
  - Removed duplicate [`SecurityLevel`](../../src/config/crypto.rs:275) enum definition (lines 272-296)
  - Updated all variant references:
    - `Interactive` → `Low`
    - `Balanced` → `Standard`
    - `Sensitive` → `High`
  - Updated method implementations in [`KeyDerivationConfig`](../../src/config/crypto.rs:149)
  - Updated test cases to use new enum variants

### Enhanced Error Module Updates
- **File**: [`src/crypto/enhanced_error.rs`](../../src/crypto/enhanced_error.rs)
- **Changes Made**:
  - Added import: `use crate::security_types::Severity;`
  - Removed duplicate [`ErrorSeverity`](../../src/crypto/enhanced_error.rs:17) enum definition (lines 17-26)
  - Updated all struct field types from `ErrorSeverity` to `Severity`
  - Updated method signature: `severity() -> &Severity`
  - Updated variant references:
    - `Low` → `Info`
    - `Medium` → `Warning`
    - `High` → `Error`
    - `Critical` → `Critical`
  - Updated error construction and test cases

### Security Types Module Enhancement
- **File**: [`src/security_types.rs`](../../src/security_types.rs)
- **Changes Made**:
  - Added `as_str()` method to [`SecurityLevel`](../../src/security_types.rs:187) for backward compatibility
  - Method returns string representation ("Low", "Standard", "High")

### Import and Usage Updates
- **Updated Files**:
  - [`src/crypto/mod.rs`](../../src/crypto/mod.rs): Removed `ErrorSeverity` from exports
  - [`src/crypto/audit_logger.rs`](../../src/crypto/audit_logger.rs): Updated imports and variant usage
  - [`src/lib.rs`](../../src/lib.rs): Added `SecurityLevel` and `Severity` to public re-exports
  - [`src/bin/datafold_cli.rs`](../../src/bin/datafold_cli.rs): Updated imports and variant mappings
  - [`src/datafold_node/crypto_routes.rs`](../../src/datafold_node/crypto_routes.rs): Updated imports
  - [`src/datafold_node/crypto_validation.rs`](../../src/datafold_node/crypto_validation.rs): Updated imports and variant usage

### Compilation Verification
- All modules compile successfully with `cargo check`
- No breaking changes to existing functionality
- All security enum variants properly unified

## Completion Criteria

- [x] All duplicate [`SecurityLevel`](../../src/config/crypto.rs:275) and [`ErrorSeverity`](../../src/crypto/enhanced_error.rs:17) enum definitions removed
- [x] All modules successfully import and use unified types from [`security_types.rs`](../../src/security_types.rs)
- [x] All code compiles successfully (`cargo check` passes)
- [x] Existing functionality preserved (no behavior changes)
- [x] Tests pass with updated enum variants
- [x] Task status updated to "Completed" in [`tasks.md`](./tasks.md)

## Related Tasks

- [Task 25-1](./25-1.md): Comprehensive security enum audit (Completed)
- [Task 25-2](./25-2.md): Create shared security types module (InProgress) 
- [Task 25-3](./25-3.md): Refactor rotation and audit modules (Completed)
- [Task 25-4](./25-4.md): Refactor monitoring modules (Completed)
- [Task 25-5](./25-5.md): Refactor compliance modules (Completed)
- [Task 25-7](./25-7.md): Clean up imports and remove duplicates (Proposed)