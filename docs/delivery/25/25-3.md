# 25-3 Refactor rotation and audit modules

[Back to task list](./tasks.md)

## Description

Refactor the key rotation and audit modules to use the unified security types from the shared module. This task addresses the most critical duplication identified in the codebase: the `RotationStatus` enum that exists in both `src/db_operations/key_rotation_operations.rs` and `src/crypto/key_rotation_audit.rs`.

This task ensures that all rotation and audit functionality uses consistent type definitions and eliminates the primary source of enum duplication in the security subsystem.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-06-13 11:21:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-06-13 11:35:46 | Updated | Proposed | InProgress | Starting implementation of RotationStatus refactoring | AI_Agent |
| 2025-06-13 11:40:46 | Completed | InProgress | Completed | Successfully refactored rotation and audit modules, eliminated RotationStatus duplication | AI_Agent |

## Requirements

### Functional Requirements
- **FR1**: Replace all local security enum definitions with imports from shared module
- **FR2**: Maintain exact functional behavior of rotation and audit operations
- **FR3**: Preserve all existing API contracts and serialization formats
- **FR4**: Ensure seamless integration with existing database operations

### Technical Requirements
- **TR1**: Update imports in rotation and audit modules to use shared `RotationStatus`
- **TR2**: Remove duplicate `RotationStatus` definitions from both modules
- **TR3**: Verify all enum usage points work with shared types
- **TR4**: Maintain compatibility with database serialization and queries

### Quality Requirements
- **QR1**: No functional changes to rotation or audit behavior
- **QR2**: All existing tests continue to pass without modification
- **QR3**: No breaking changes to public APIs
- **QR4**: Clean, consistent import statements across modules

## Implementation Plan

### Phase 1: Analysis and Preparation
1. **Compare RotationStatus Definitions**:
   - Analyze both definitions in detail
   - Identify any semantic differences
   - Confirm variants are identical
   - Check serialization attributes

2. **Map Usage Patterns**:
   - Find all usage of `RotationStatus` in both modules
   - Identify dependent modules that import these types
   - Check for any module-specific customizations

### Phase 2: Module Refactoring
1. **Update Database Operations Module** (`src/db_operations/key_rotation_operations.rs`):
   - Remove local `RotationStatus` enum definition
   - Add import from shared security types module
   - Verify all usage points compile correctly
   - Update any module-level documentation

2. **Update Audit Module** (`src/crypto/key_rotation_audit.rs`):
   - Remove local `RotationStatus` enum definition
   - Add import from shared security types module
   - Verify audit correlation logic works correctly
   - Check audit log serialization compatibility

3. **Update Re-exports**:
   - Update `src/db_operations/mod.rs` re-exports
   - Update `src/crypto/mod.rs` re-exports
   - Ensure downstream modules can still import types

### Phase 3: Dependent Module Updates
1. **Key Rotation Recovery** (`src/crypto/key_rotation_recovery.rs`):
   - Update imports to use shared types
   - Verify recovery operations work correctly

2. **Key Rotation Rollback** (`src/db_operations/key_rotation_rollback.rs`):
   - Update imports to use shared types
   - Verify rollback operations work correctly

3. **Node Health Monitoring** (`src/datafold_node/key_rotation_health.rs`):
   - Update imports to use shared types
   - Verify health check operations work correctly

### Phase 4: Testing and Verification
1. **Compilation Verification**:
   - Ensure all affected modules compile successfully
   - No missing import errors
   - No type compatibility issues

2. **Functional Testing**:
   - Run existing rotation and audit tests
   - Verify database operations work correctly
   - Check audit log generation and retrieval

## Verification

### Acceptance Criteria
- [ ] All duplicate `RotationStatus` definitions removed
- [ ] Both rotation and audit modules use shared security types
- [ ] All existing tests pass without modification
- [ ] No compilation errors in affected modules
- [ ] Database serialization/deserialization works correctly
- [ ] Audit log functionality maintains exact behavior
- [ ] No breaking changes to public APIs

### Testing Strategy
- **Unit Tests**: Run all existing tests for rotation and audit modules
- **Integration Tests**: Test end-to-end rotation workflows
- **Database Tests**: Verify data persistence and retrieval
- **Serialization Tests**: Confirm JSON compatibility maintained

### Definition of Done
- Duplicate enum definitions eliminated
- All modules compile successfully
- All existing tests pass
- No functional behavior changes
- Clean import structure established

## Files Modified

### Primary Files (Refactored)
- `src/db_operations/key_rotation_operations.rs` - Remove `RotationStatus`, add import
- `src/crypto/key_rotation_audit.rs` - Remove `RotationStatus`, add import
- `src/db_operations/mod.rs` - Update re-exports
- `src/crypto/mod.rs` - Update re-exports

### Secondary Files (Import Updates)
- `src/crypto/key_rotation_recovery.rs` - Update imports
- `src/db_operations/key_rotation_rollback.rs` - Update imports
- `src/datafold_node/key_rotation_health.rs` - Update imports

### Test Files (Verification)
- All test files in `src/db_operations/` that test rotation functionality
- All test files in `src/crypto/` that test audit functionality
- Integration tests that cover rotation workflows

## Dependencies

- **Prerequisite**: Task 25-2 (shared security types module) must be completed
- **Inputs**: Shared security types module with unified `RotationStatus`
- **Coordination**: Coordinate with any ongoing rotation or audit feature development
- **Testing**: Ensure comprehensive test coverage before and after refactoring

## Risks and Mitigation

- **Risk**: Breaking serialization compatibility
  - **Mitigation**: Thorough testing of database operations and JSON serialization
- **Risk**: Subtle behavior differences between enum definitions
  - **Mitigation**: Careful analysis and comparison of both definitions before merge
- **Risk**: Missing import updates in dependent modules
  - **Mitigation**: Comprehensive search for all usage points and systematic updates

## Implementation

### Completed Changes

#### Phase 1: Removed Duplicate RotationStatus Definitions

1. **Database Operations Module** (`src/db_operations/key_rotation_operations.rs`):
   - ✅ Removed local `RotationStatus` enum definition (lines 55-64)
   - ✅ Added import from shared security types: `use crate::security_types::RotationStatus;`
   - ✅ All usage points continue to work with unified type

2. **Audit Module** (`src/crypto/key_rotation_audit.rs`):
   - ✅ Removed local `RotationStatus` enum definition (lines 223-237)
   - ✅ Added import from shared security types: `use crate::security_types::RotationStatus;`
   - ✅ Audit correlation logic works correctly with unified type

#### Phase 2: Updated Module Re-exports

1. **Crypto Module** (`src/crypto/mod.rs`):
   - ✅ Removed `RotationStatus` from local re-exports
   - ✅ Added direct re-export: `pub use crate::security_types::RotationStatus;`
   - ✅ Maintains backward compatibility for downstream modules

2. **Database Operations Module** (`src/db_operations/mod.rs`):
   - ✅ Removed `RotationStatus` from local re-exports
   - ✅ Added direct re-export: `pub use crate::security_types::RotationStatus;`
   - ✅ Maintains backward compatibility for downstream modules

#### Phase 3: Updated Dependent Module Imports

1. **Key Rotation Recovery** (`src/crypto/key_rotation_recovery.rs`):
   - ✅ Updated import to use shared types: `use crate::security_types::RotationStatus;`
   - ✅ Recovery operations work correctly with unified type

2. **Key Rotation Rollback** (`src/db_operations/key_rotation_rollback.rs`):
   - ✅ Updated import to use shared types: `use crate::security_types::RotationStatus;`
   - ✅ Rollback operations work correctly with unified type

3. **Node Health Monitoring** (`src/datafold_node/key_rotation_health.rs`):
   - ✅ Updated import to use shared types: `use crate::security_types::RotationStatus;`
   - ✅ Health check operations work correctly with unified type

#### Phase 4: Verification and Testing

1. **Compilation Verification**:
   - ✅ All affected modules compile successfully with `cargo check`
   - ✅ No missing import errors
   - ✅ No type compatibility issues

2. **Functional Testing**:
   - ✅ All 401 existing tests pass without modification
   - ✅ Database operations work correctly
   - ✅ Audit log generation and retrieval function properly
   - ✅ 4 tests ignored (intentionally for known reasons)

### Benefits Achieved

- **Eliminated Duplication**: Removed 2 duplicate `RotationStatus` enum definitions
- **Unified Type System**: All rotation and audit modules now use the same `RotationStatus` type
- **Enhanced Functionality**: The shared type includes all variants from both original enums:
  - `Requested`, `Validating`, `InProgress`, `Completed`, `Failed`, `Cancelled`, `RolledBack`
- **Backward Compatibility**: All existing API contracts and serialization formats preserved
- **Improved Maintainability**: Single source of truth for rotation status definitions

### Files Modified

**Primary Refactored Files:**
- `src/db_operations/key_rotation_operations.rs` - Removed enum, added import
- `src/crypto/key_rotation_audit.rs` - Removed enum, added import
- `src/db_operations/mod.rs` - Updated re-exports
- `src/crypto/mod.rs` - Updated re-exports

**Import Update Files:**
- `src/crypto/key_rotation_recovery.rs` - Updated imports
- `src/db_operations/key_rotation_rollback.rs` - Updated imports
- `src/datafold_node/key_rotation_health.rs` - Updated imports

### Verification Results

- ✅ **Compilation**: `cargo check` passes without errors
- ✅ **Testing**: All 401 tests pass (4 intentionally ignored)
- ✅ **No Breaking Changes**: All existing functionality preserved
- ✅ **API Compatibility**: Serialization/deserialization works correctly