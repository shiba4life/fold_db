# T11.3: Mandatory Signature Authentication Configuration Implementation

## Overview

T11.3 has been successfully implemented to ensure signature authentication is now a mandatory component of node configuration and cannot be omitted. This builds upon T11.1 and T11.2 to complete the signature authentication security framework.

## Changes Implemented

### 1. Node Configuration Structure Updates

**File: `src/datafold_node/config.rs`**

- **BREAKING CHANGE**: Changed `signature_auth` field from `Option<SignatureAuthConfig>` to `SignatureAuthConfig`
- Updated `serde` annotations to use `#[serde(default = "SignatureAuthConfig::default")]`
- All node configurations now include signature authentication by default

### 2. Configuration Methods Updated

#### Method Signature Changes:
- `signature_auth_config()` now returns `&SignatureAuthConfig` instead of `Option<&SignatureAuthConfig>`
- `is_signature_auth_enabled()` always returns `true` (signature auth is always enabled)
- `with_signature_auth()` replaces `enable_signature_auth()` for clarity

#### Method Renaming for Clarity:
- `development_with_signature_auth()` → `development()`
- `production_with_signature_auth()` → `production()`
- Removed `with_optional_signature_auth()` (no longer needed)

### 3. Enhanced Configuration Validation

Added mandatory signature authentication validation to `NodeConfig::validate()`:
- Validates signature auth configuration parameters
- Provides clear error messages for invalid configurations
- Integrates with existing crypto configuration validation

### 4. HTTP Server Integration

**File: `src/datafold_node/http_server.rs`**

Simplified signature verification initialization since signature auth is always available:
- Removed conditional checks for signature auth presence
- Direct initialization of `SignatureVerificationState`
- Cleaner error handling

### 5. Backward Compatibility Fixes

Updated all existing test files and usage patterns:
- **Files Updated**: `src/testing_utils.rs`, `src/datafold_node/permissions.rs`, `src/datafold_node/transform_queue.rs`
- **Test Files Updated**: All signature auth integration tests, API route protection tests, T11.2 verification tests
- Maintained functionality while enforcing mandatory signature auth

## Security Profiles

Signature authentication now supports three mandatory security profiles:

### 1. **Strict Profile** (`SecurityProfile::Strict`)
- 1-minute time window
- 5-second clock skew tolerance
- Restrictive rate limiting (50 requests/window, 3 failures max)
- Enhanced attack detection
- No detailed error messages

### 2. **Standard Profile** (`SecurityProfile::Standard`) - Default
- 5-minute time window  
- 30-second clock skew tolerance
- Balanced rate limiting (100 requests/window, 10 failures max)
- Standard attack detection
- Moderate error detail

### 3. **Lenient Profile** (`SecurityProfile::Lenient`)
- 10-minute time window
- 2-minute clock skew tolerance
- Rate limiting disabled
- Attack detection disabled
- Detailed error messages (for development)

## Configuration Examples

### Basic Node Configuration
```rust
use datafold::datafold_node::config::NodeConfig;
use std::path::PathBuf;

// All configurations now include signature auth automatically
let config = NodeConfig::new(PathBuf::from("data"));
assert!(config.is_signature_auth_enabled()); // Always true
```

### Development Configuration
```rust
// Uses lenient security profile for development
let config = NodeConfig::development(PathBuf::from("data"));
assert_eq!(config.signature_auth_config().security_profile, SecurityProfile::Lenient);
```

### Production Configuration
```rust
// Uses strict security profile for production
let config = NodeConfig::production(PathBuf::from("data"));
assert_eq!(config.signature_auth_config().security_profile, SecurityProfile::Strict);
```

### Custom Signature Authentication
```rust
let custom_config = SignatureAuthConfig {
    security_profile: SecurityProfile::Strict,
    allowed_time_window_secs: 120,
    ..SignatureAuthConfig::default()
};

let config = NodeConfig::new(PathBuf::from("data"))
    .with_signature_auth(custom_config);
```

## Error Handling

### Configuration Validation Errors

The system now provides clear error messages for signature auth configuration issues:

```rust
let mut config = NodeConfig::new(PathBuf::from("data"));
config.signature_auth.allowed_time_window_secs = 0; // Invalid

match config.validate() {
    Err(e) => {
        // Error: "Signature auth validation failed: Time window must be greater than 0"
        assert!(e.to_string().contains("Signature auth validation failed"));
    }
    Ok(_) => panic!("Should have failed validation"),
}
```

### Common Validation Errors:
1. **Zero time window**: `Time window must be greater than 0`
2. **Zero nonce TTL**: `Nonce TTL must be greater than 0`
3. **Zero nonce store size**: `Nonce store size must be greater than 0`
4. **Invalid clock skew**: `Clock skew tolerance cannot exceed time window`

## Test Coverage

Created comprehensive test suite: `tests/t11_3_mandatory_auth_config_test.rs`

**11 Tests Covering:**
- ✅ Default configuration includes signature auth
- ✅ `new()` method includes signature auth  
- ✅ Development profile uses lenient security
- ✅ Production profile uses strict security
- ✅ Configuration validation includes signature auth
- ✅ Custom signature auth configuration
- ✅ Node creation with mandatory signature auth
- ✅ Individual signature auth validation
- ✅ Backward compatibility with crypto config
- ✅ Security profiles have different settings
- ✅ Serialization includes signature auth

## Breaking Changes

### For Library Users:
1. **Configuration Structure**: `signature_auth` is no longer `Option<T>`
2. **Method Returns**: `signature_auth_config()` returns `&SignatureAuthConfig` not `Option<&SignatureAuthConfig>`
3. **Method Names**: Configuration methods renamed for clarity

### Migration Guide:
```rust
// Before T11.3
if let Some(sig_config) = node_config.signature_auth_config() {
    // Use sig_config
}

// After T11.3  
let sig_config = node_config.signature_auth_config();
// sig_config is always available
```

## Benefits

### Security Benefits:
1. **No Opt-Out**: Signature authentication cannot be accidentally disabled
2. **Clear Configuration**: Explicit security profile selection
3. **Validation**: Configuration errors caught early
4. **Consistent Security**: All nodes have authentication enabled

### Developer Benefits:
1. **Simplified Logic**: No need to check for signature auth presence
2. **Clear Errors**: Descriptive validation error messages
3. **Flexible Profiles**: Easy switching between security levels
4. **Backward Compatible**: Existing configurations work with updates

## Verification

Run the comprehensive test suite to verify implementation:

```bash
# Run T11.3 specific tests
cargo test --test t11_3_mandatory_auth_config_test

# Run all signature auth related tests
cargo test signature_auth

# Verify integration
cargo test api_route_protection
```

## Conclusion

T11.3 successfully implements mandatory signature authentication configuration, completing the signature authentication security framework started in T11.1 and T11.2. The implementation ensures:

- **Security**: All nodes must have signature authentication configured
- **Reliability**: Clear validation prevents misconfigurations  
- **Usability**: Simple API with sensible defaults
- **Compatibility**: Existing code works with minimal changes

The system now provides a robust, mandatory signature authentication framework that cannot be bypassed or accidentally disabled.