# Task 33-3: Implement Core Unified Cryptographic Module (Primitives Layer)

## Status History

| Date (UTC)           | Status      | Actor      | Notes                                      |
|----------------------|-------------|------------|---------------------------------------------|
| 2025-06-19T16:33:42Z | Agreed      | Code       | Task scope and implementation plan agreed   |
| 2025-06-19T16:33:42Z | InProgress  | Code       | Core cryptographic module implementation started |
| 2025-06-19T16:48:39Z | Review      | Code       | Core cryptographic module implementation complete |

---

## 1. Task Overview

Implement the core unified cryptographic module according to the architectural design from Task 33-2. This task creates the primitives layer foundation that will serve as the secure foundation for consolidating all cryptographic logic across the DataFold system.

## 2. Implementation Scope

### 2.1 Core Module Structure
- `src/unified_crypto/mod.rs` - Main module file with public API exports
- `src/unified_crypto/primitives.rs` - Core cryptographic primitives (encryption, signing, hashing)
- `src/unified_crypto/keys.rs` - Key management operations and lifecycle
- `src/unified_crypto/config.rs` - Cryptographic configuration handling
- `src/unified_crypto/types.rs` - Cryptographic type definitions and structures
- `src/unified_crypto/error.rs` - Security error handling and error types
- `src/unified_crypto/audit.rs` - Security audit and logging capabilities

### 2.2 Primitives Layer APIs
- **Encryption/Decryption**: AES-GCM, ChaCha20-Poly1305 support
- **Digital Signatures**: RSA-PSS, Ed25519 support
- **Hashing**: SHA-256, SHA-3, BLAKE3 support
- **Key Derivation**: PBKDF2, Argon2, HKDF support
- **Random Number Generation**: Secure random generation

### 2.3 Security Features
- Secure memory handling with zeroization
- Comprehensive input validation and bounds checking
- Timing attack protections
- Secure random number generation
- Access controls and security boundaries
- Comprehensive audit logging

## 3. Security Requirements

### 3.1 Memory Security
- Use `zeroize` crate for secure memory clearing
- Minimize lifetime of sensitive data in memory
- Protect against memory dumps and side-channel attacks

### 3.2 Input Validation
- Strict validation of all inputs (keys, plaintexts, ciphertexts)
- Bounds checking for all array operations
- Proper error handling for malformed inputs

### 3.3 Cryptographic Security
- Use only proven, well-established cryptographic algorithms
- Implement proper authentication for all encryption operations
- Ensure crypto-agility for future algorithm transitions

### 3.4 Audit and Monitoring
- Log all cryptographic operations for security audit
- Include operation metadata (algorithm, key ID, timestamp)
- Provide tamper-evident audit trails

## 4. Implementation Guidelines

### 4.1 Dependencies
- `ring` - For core cryptographic primitives
- `ed25519-dalek` - For Ed25519 signature operations
- `argon2` - For password-based key derivation
- `zeroize` - For secure memory handling
- `serde` - For configuration serialization
- `thiserror` - For error handling

### 4.2 Error Handling
- Define comprehensive error types for all failure modes
- Include security-relevant error context without leaking sensitive data
- Implement proper error propagation with audit logging

### 4.3 Testing Strategy
- Unit tests for all primitive operations
- Property-based testing for cryptographic invariants
- Security tests for timing and side-channel resistance
- Integration tests with existing crypto modules

## 5. Integration Points

### 5.1 Configuration Integration
- Integrate with existing `config::crypto` module
- Support dynamic algorithm selection
- Maintain backward compatibility during transition

### 5.2 Database Integration
- Interface with existing `db_operations::crypto_metadata`
- Support existing key storage formats during migration
- Provide secure key lifecycle management

### 5.3 CLI Integration
- Interface with existing CLI crypto operations
- Support existing authentication and signing workflows
- Maintain CLI backward compatibility

## 6. Success Criteria

### 6.1 Functional Requirements
- [x] Core module structure implemented
- [x] Primitives layer APIs functional
- [x] Key management operations working
- [x] Configuration system integrated
- [x] Error handling comprehensive
- [x] Audit logging operational

### 6.2 Security Requirements
- [x] Memory security implemented (zeroization)
- [x] Input validation comprehensive
- [x] Timing attack protections in place
- [x] Secure random generation working
- [x] Access controls enforced
- [x] Audit trails complete

### 6.3 Quality Requirements
- [x] Code documentation complete
- [x] Unit tests passing
- [x] Integration tests functional
- [x] Security review completed

## 7. References

- Task 33-2 Architecture: [`docs/delivery/33/33-2.md`](./33-2.md)
- Task 33-1 Analysis: [`docs/delivery/33/33-1.md`](./33-1.md)
- Task Index: [`docs/delivery/33/tasks.md`](./tasks.md)
- .cursorrules: Project policy and workflow