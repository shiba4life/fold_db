# Task 8-8: Add CLI support for secure database initialization

**Task ID**: 8-8  
**Status**: Proposed â†’ InProgress  
**Parent PBI**: [PBI 8: Database Master Key Encryption](./prd.md)  
**Dependencies**: 8-7 (HTTP API endpoints for crypto initialization)

## Overview

Enhance the DataFold CLI tool with secure database initialization capabilities, providing command-line interfaces for cryptographic setup workflows. This task extends the existing CLI tool with crypto initialization commands that integrate with the previously implemented crypto initialization system.

## Success Criteria

- [ ] CLI commands for crypto initialization workflows
- [ ] Secure passphrase input handling (hidden input, validation)
- [ ] CLI options for different security levels and configurations
- [ ] Integration with existing crypto initialization workflow
- [ ] Comprehensive error handling and user-friendly messages
- [ ] Testing of CLI functionality

## Technical Requirements

### CLI Command Structure

Add new subcommands to the existing `datafold_cli.rs`:

```bash
# Initialize database crypto with random key generation
datafold-cli crypto-init --method random [--security-level <level>]

# Initialize database crypto with passphrase-based key derivation
datafold-cli crypto-init --method passphrase [--security-level <level>]

# Check crypto initialization status
datafold-cli crypto-status

# Validate crypto configuration
datafold-cli crypto-validate --config <config-file>
```

### Security Features

1. **Secure Passphrase Input**
   - Hidden password input using terminal features
   - Passphrase confirmation for safety
   - Minimum length validation (6+ characters)
   - Memory cleanup after use

2. **Security Level Options**
   - `interactive` - Balanced parameters for interactive use
   - `balanced` - Default balanced security/performance 
   - `sensitive` - Maximum security for sensitive data

3. **Configuration Integration**
   - Read crypto config from node configuration file
   - Override config options via CLI parameters
   - Validate configuration before initialization

### Error Handling

- Clear, actionable error messages for common issues
- Specific guidance for crypto configuration problems
- Safe error handling that doesn't leak sensitive information
- Proper exit codes for scripting integration

### Implementation Plan

#### Phase 1: Core CLI Structure
1. Extend `Commands` enum with crypto initialization commands
2. Add crypto-specific command-line argument parsing
3. Create handler functions for each crypto command

#### Phase 2: Secure Input Handling
1. Implement secure passphrase input with hidden terminal input
2. Add passphrase validation and confirmation logic
3. Implement secure memory cleanup for sensitive data

#### Phase 3: Crypto Integration
1. Integrate with existing `initialize_database_crypto` function
2. Add support for security level configuration
3. Implement status checking and validation commands

#### Phase 4: Error Handling & UX
1. Add comprehensive error handling with user-friendly messages
2. Implement proper exit codes and logging
3. Add help text and usage examples

#### Phase 5: Testing
1. Unit tests for CLI argument parsing
2. Integration tests for crypto initialization workflows
3. Security tests for passphrase handling

## Dependencies

- `clap` - Command-line argument parsing (already available)
- `rpassword` - Secure password input handling
- Existing crypto initialization system from tasks 8-1 through 8-7

## File Changes

### New Files
- Tests for CLI crypto functionality

### Modified Files
- `src/bin/datafold_cli.rs` - Add crypto initialization commands
- `Cargo.toml` - Add `rpassword` dependency for secure input
- Test files for CLI crypto functionality

## Security Considerations

1. **Passphrase Handling**
   - Never store passphrases in memory longer than necessary
   - Use secure memory clearing after passphrase processing
   - Avoid logging or displaying passphrases

2. **Error Messages**
   - Provide helpful error messages without revealing sensitive details
   - Avoid including key material or detailed crypto internals in errors

3. **Configuration Security**
   - Validate all crypto configuration parameters
   - Prevent weak or insecure configuration options
   - Clear guidance on security implications of different options

## Testing Strategy

1. **Unit Tests**
   - CLI argument parsing for all crypto commands
   - Error handling for invalid inputs
   - Security level configuration validation

2. **Integration Tests**
   - End-to-end crypto initialization workflows
   - Integration with existing database systems
   - Cross-validation with HTTP API functionality

3. **Security Tests**
   - Passphrase handling and memory cleanup
   - Configuration validation edge cases
   - Error message security (no information leakage)

## Documentation Requirements

- Update CLI help text and usage examples
- Add crypto initialization examples to documentation
- Security best practices for CLI usage

## Acceptance Criteria

1. CLI successfully initializes database crypto with both random and passphrase methods
2. Secure passphrase input works correctly with hidden input and confirmation
3. All security levels (interactive, balanced, sensitive) function properly
4. Error handling provides clear, actionable feedback
5. Integration with existing crypto system works seamlessly
6. All tests pass and provide good coverage
7. Documentation is complete and accurate

## Implementation Notes

- Follow existing CLI patterns and error handling approaches
- Integrate cleanly with existing crypto initialization workflow
- Maintain security best practices throughout implementation
- Ensure compatibility with existing configuration system