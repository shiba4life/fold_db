# [8-6] Enhance database initialization with crypto setup

[Back to task list](./tasks.md)

## Description

Integrate cryptographic initialization into DataFold's existing database creation workflow. This will enable automatic setup of master key encryption during database initialization, ensuring that new databases can be created with cryptographic protection from the start.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2024-12-30 17:45:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2024-12-30 17:46:00 | Status Update | Proposed | Agreed | Task approved for implementation | tomtang |
| 2024-12-30 17:47:00 | Status Update | Agreed | InProgress | Started database initialization enhancement | AI Agent |
| 2025-01-07 23:57:30 | Status Update | InProgress | Done | Database crypto initialization integration completed with comprehensive testing | AI Agent |

## Requirements

1. **Database Creation Integration**: Modify database creation to support crypto initialization
2. **NodeConfig Integration**: Use crypto configuration from NodeConfig during database setup
3. **Key Generation**: Generate or derive master keys based on configuration during initialization
4. **Metadata Storage**: Store crypto metadata automatically during database creation
5. **Error Handling**: Comprehensive error handling for crypto initialization failures
6. **Backward Compatibility**: Ensure existing database creation workflows continue to work
7. **Configuration Validation**: Validate crypto configuration before database creation

## Implementation Plan

### Phase 1: Analyze Current Database Initialization
- Examine existing database creation workflow in DataFoldNode
- Identify integration points for crypto initialization
- Map current error handling and validation patterns

### Phase 2: Crypto Initialization Module
- Create crypto initialization functions for database setup
- Implement key generation/derivation based on NodeConfig
- Add crypto metadata storage during initialization
- Handle different crypto configuration scenarios

### Phase 3: Integration with Database Creation
- Modify database creation workflow to include crypto setup
- Add crypto validation before database creation
- Ensure seamless integration with existing initialization
- Maintain backward compatibility for non-crypto databases

### Phase 4: Error Handling and Validation
- Implement comprehensive error handling for crypto failures
- Add validation for crypto configuration consistency
- Provide clear error messages for crypto initialization issues
- Handle edge cases and recovery scenarios

### Phase 5: Testing and Documentation
- Unit tests for crypto initialization functions
- Integration tests for database creation with crypto
- End-to-end tests with different crypto configurations
- Update documentation for crypto-enabled database creation

## Test Plan

### Unit Tests
- **Crypto Initialization Functions**:
  - Initialize database with random key generation
  - Initialize database with passphrase-derived keys
  - Handle invalid crypto configurations gracefully
  - Validate crypto metadata storage during initialization

- **Configuration Validation**:
  - Validate crypto configuration before database creation
  - Handle missing or incomplete crypto configuration
  - Test different security level configurations
  - Verify Argon2 parameter validation

- **Error Handling**:
  - Crypto initialization failure scenarios
  - Key generation/derivation errors
  - Metadata storage failures
  - Configuration validation errors

### Integration Tests
- **Database Creation Workflow**:
  - Create database with crypto enabled using random keys
  - Create database with crypto enabled using passphrase
  - Create database without crypto (backward compatibility)
  - Verify crypto metadata is stored correctly

- **NodeConfig Integration**:
  - Test with different NodeConfig crypto configurations
  - Verify configuration validation during database creation
  - Test fluent API for crypto configuration
  - Validate serialization/deserialization of crypto config

- **End-to-End Scenarios**:
  - Complete database setup with crypto from CLI
  - Database creation through HTTP API with crypto
  - Multiple database creation with different crypto configs
  - Database opening after crypto initialization

### Success Criteria
- All unit tests pass with >95% code coverage
- Integration tests validate complete crypto initialization workflow
- Backward compatibility maintained for existing databases
- Error handling provides clear, actionable error messages
- Performance impact minimal for crypto initialization
- Documentation complete and accurate

## Verification

- [ ] Current database initialization workflow analyzed and documented
- [ ] Crypto initialization module implemented with key generation/derivation
- [ ] Integration with existing database creation workflow complete
- [ ] NodeConfig crypto configuration validation implemented
- [ ] Automatic crypto metadata storage during initialization working
- [ ] Comprehensive error handling for all crypto initialization scenarios
- [ ] Backward compatibility verified for existing database creation
- [ ] Unit tests covering all crypto initialization functions
- [ ] Integration tests validating complete database creation workflow
- [ ] End-to-end tests with different crypto configurations
- [ ] Performance benchmarks showing acceptable initialization overhead
- [ ] Documentation updated with crypto initialization examples

## Files Modified

**New Files**:
- `src/datafold_node/crypto_init.rs` - Crypto initialization functions for database setup
- `src/datafold_node/crypto_validation.rs` - Configuration validation for crypto setup

**Modified Files**:
- `src/datafold_node/mod.rs` - Module exports and organization
- `src/datafold_node/node.rs` - Database initialization integration
- `src/lib.rs` - Re-export crypto initialization functions

**Test Files**:
- `tests/database_crypto_init_test.rs` - Comprehensive database crypto initialization testing
- `tests/integration/node_crypto_workflow_test.rs` - End-to-end crypto workflow testing

**Documentation**:
- Database initialization documentation updates
- Crypto configuration examples and best practices 