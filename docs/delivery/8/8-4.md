# [8-4] Enhance NodeConfig for cryptographic initialization

[Back to task list](./tasks.md)

## Description

Enhance DataFold's NodeConfig system to support database cryptographic initialization parameters. This will enable users to configure master key encryption settings when initializing new database instances, providing a clean configuration interface for the cryptographic features implemented in previous tasks.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2024-12-30 15:15:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2024-12-30 15:16:00 | Status Update | Proposed | Agreed | Task approved for implementation | tomtang |
| 2024-12-30 15:17:00 | Status Update | Agreed | InProgress | Started NodeConfig enhancement work | AI Agent |
| 2024-12-30 16:00:00 | Status Update | InProgress | Review | Completed NodeConfig crypto integration and testing | AI Agent |
| 2024-12-30 16:30:00 | Status Update | Review | Done | Task approved and completed | tomtang |

## Requirements

1. **Config Structure Enhancement**: Extend NodeConfig to include cryptographic initialization options
2. **Passphrase Configuration**: Support passphrase-based master key derivation settings
3. **Argon2 Parameter Configuration**: Allow custom Argon2 parameters for different security levels
4. **Key Generation Options**: Support both passphrase-based and random key generation modes
5. **Validation**: Comprehensive validation of cryptographic configuration parameters
6. **Backward Compatibility**: Ensure existing configurations continue to work without crypto settings
7. **Security Defaults**: Provide secure default parameters when crypto is enabled

## Implementation Plan

1. **Analyze Current NodeConfig**:
   - Review existing `src/config_utils.rs` structure
   - Understand current configuration patterns
   - Identify integration points for crypto settings

2. **Define Crypto Configuration Types**:
   - Create `CryptoConfig` structure for database encryption settings
   - Define `KeyDerivationConfig` for Argon2 parameters
   - Add `MasterKeyConfig` enum for different key generation modes

3. **Extend NodeConfig Structure**:
   - Add optional `crypto` field to NodeConfig
   - Implement serialization/deserialization
   - Add validation methods for crypto parameters

4. **Configuration Validation**:
   - Validate Argon2 parameters meet security requirements
   - Check passphrase strength requirements (if specified)
   - Ensure configuration consistency

5. **Integration with Crypto Module**:
   - Connect config types with crypto module functionality
   - Provide conversion methods from config to crypto types
   - Add convenience methods for crypto initialization

6. **Testing and Documentation**:
   - Unit tests for configuration parsing and validation
   - Integration tests with crypto module
   - Update configuration documentation

## Test Plan

**Objective**: Verify that NodeConfig correctly handles cryptographic initialization parameters and integrates seamlessly with the crypto module.

**Test Scope**: Configuration parsing, validation, serialization, and integration with crypto functionality.

**Key Test Scenarios**:
- Parse valid crypto configurations from TOML/JSON
- Reject invalid crypto configurations with clear error messages
- Serialize and deserialize crypto configs without data loss
- Convert config parameters to crypto module types
- Validate Argon2 parameter bounds and security requirements
- Ensure backward compatibility with non-crypto configurations
- Test default parameter selection for different security levels

**Success Criteria**:
- All valid crypto configurations parse correctly
- Invalid configurations are rejected with helpful error messages
- Serialization round-trips preserve all data
- Config-to-crypto type conversions work seamlessly
- Validation catches security issues early
- Existing configurations remain unaffected
- Performance impact is minimal

## Verification

- [x] CryptoConfig types defined and integrated with NodeConfig
- [x] Passphrase-based key derivation configuration supported
- [x] Argon2 parameter customization implemented
- [x] Configuration validation with security checks added
- [x] Serialization/deserialization working correctly
- [x] Integration with crypto module functionality complete
- [x] Backward compatibility maintained for existing configs
- [x] Comprehensive unit tests covering all config scenarios
- [x] Documentation updated with crypto configuration examples

## Files Modified

**New Files**:
- `src/config/mod.rs` - Configuration module organization
- `src/config/crypto.rs` - Comprehensive crypto configuration types and validation
- `tests/config_crypto_test.rs` - Integration tests for crypto configuration with NodeConfig

**Modified Files**:
- `src/datafold_node/config.rs` - Enhanced NodeConfig with optional crypto field and validation
- `src/lib.rs` - Added config module and re-exported crypto config types
- `src/datafold_node/permissions.rs` - Updated NodeConfig initialization to include crypto field
- `src/datafold_node/transform_queue.rs` - Updated NodeConfig initialization to include crypto field
- `src/testing_utils.rs` - Updated test NodeConfig creation to include crypto field

**Implementation Summary**:
- Created comprehensive CryptoConfig with MasterKeyConfig enum (Random, Passphrase, External)
- Implemented KeyDerivationConfig with Argon2 parameter customization and security presets
- Added SecurityLevel enum (Interactive, Balanced, Sensitive) for easy configuration
- Integrated crypto configuration as optional field in NodeConfig with validation
- Maintained full backward compatibility with existing configurations
- Added fluent API methods for crypto configuration (with_crypto, enable_crypto)
- Created 27 comprehensive tests (10 unit + 17 integration) covering all scenarios
- Ensured seamless integration with existing crypto module functionality 