# [8-7] Implement HTTP API endpoints for crypto initialization

[Back to task list](./tasks.md)

## Description

Create REST endpoints for programmatic database cryptographic initialization. This will enable external clients to initialize database encryption via HTTP API calls, supporting both random key generation and passphrase-based key derivation workflows.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-07 23:59:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. **Crypto Initialization Endpoints**: REST endpoints for different crypto initialization methods
2. **Secure Passphrase Handling**: Safe transmission and handling of passphrase data via HTTPS
3. **Configuration Validation**: API-level validation of crypto configuration parameters
4. **Status Endpoints**: APIs to check crypto initialization status and health
5. **Error Handling**: Comprehensive HTTP error responses for crypto operation failures
6. **Security Headers**: Proper security headers for crypto-related endpoints
7. **Integration**: Use existing crypto initialization workflow from task 8-6

## Implementation Plan

### Phase 1: Define API Specification
- Design REST API endpoints for crypto initialization
- Define request/response schemas for different initialization methods
- Specify error response formats and HTTP status codes
- Design security considerations for passphrase transmission

### Phase 2: Implement Crypto Routes Module
- Create dedicated routes module for crypto initialization
- Implement handlers for each crypto initialization method
- Add request validation and sanitization
- Integrate with existing crypto_init module from task 8-6

### Phase 3: Add Status and Management Endpoints
- Implement crypto status checking endpoints
- Add endpoints for crypto configuration validation
- Create health check endpoints for crypto subsystem
- Add administrative endpoints for crypto management

### Phase 4: Security Implementation
- Add proper security headers for crypto endpoints
- Implement secure passphrase handling
- Add rate limiting for crypto operations
- Ensure HTTPS requirements for sensitive operations

### Phase 5: Error Handling and Testing
- Comprehensive error handling with proper HTTP status codes
- Unit tests for all crypto API endpoints
- Integration tests for complete crypto initialization workflows
- Security testing for passphrase handling

## API Specification

### Endpoints

#### POST /api/crypto/init/random
Initialize database crypto with randomly generated keys.

**Request Body**: None

**Response**:
```json
{
  "success": true,
  "data": {
    "initialized": true,
    "derivation_method": "Random",
    "public_key": "...",
    "created_at": "2025-01-07T23:59:00Z"
  }
}
```

#### POST /api/crypto/init/passphrase
Initialize database crypto with passphrase-derived keys.

**Request Body**:
```json
{
  "passphrase": "user-provided-passphrase",
  "security_level": "interactive", // "interactive" | "balanced" | "sensitive"
  "custom_params": { // optional
    "memory_cost": 65536,
    "time_cost": 2,
    "parallelism": 1
  }
}
```

**Response**:
```json
{
  "success": true,
  "data": {
    "initialized": true,
    "derivation_method": "Argon2id-Interactive",
    "public_key": "...",
    "created_at": "2025-01-07T23:59:00Z"
  }
}
```

#### GET /api/crypto/status
Get current crypto initialization status.

**Response**:
```json
{
  "success": true,
  "data": {
    "initialized": true,
    "version": 1,
    "algorithm": "Ed25519",
    "derivation_method": "Argon2id-Interactive",
    "created_at": "2025-01-07T23:59:00Z",
    "integrity_verified": true
  }
}
```

#### POST /api/crypto/validate
Validate crypto configuration without initializing.

**Request Body**:
```json
{
  "method": "passphrase", // "random" | "passphrase"
  "passphrase": "test-passphrase", // required for passphrase method
  "security_level": "interactive"
}
```

**Response**:
```json
{
  "success": true,
  "data": {
    "valid": true,
    "warnings": ["Passphrase is shorter than recommended minimum of 12 characters"]
  }
}
```

### Error Responses

All endpoints return errors in this format:
```json
{
  "success": false,
  "error": {
    "code": "CRYPTO_ALREADY_INITIALIZED",
    "message": "Database already has crypto metadata initialized",
    "details": {}
  }
}
```

## Test Plan

### Unit Tests
- **Endpoint Handlers**:
  - Random key initialization endpoint
  - Passphrase-based initialization endpoint
  - Status checking endpoint
  - Configuration validation endpoint

- **Request Validation**:
  - Invalid request body handling
  - Missing required fields
  - Malformed JSON requests
  - Security parameter validation

- **Error Handling**:
  - Already initialized database
  - Invalid crypto configuration
  - Database operation failures
  - Concurrent initialization attempts

### Integration Tests
- **Complete Workflows**:
  - End-to-end random key initialization via API
  - End-to-end passphrase initialization via API
  - Status checking after initialization
  - Multiple initialization attempt handling

- **Security Tests**:
  - Passphrase handling security
  - Error message information disclosure
  - Rate limiting effectiveness
  - HTTPS requirement enforcement

### Success Criteria
- All unit tests pass with >95% code coverage
- Integration tests validate complete crypto initialization workflows
- Security tests confirm safe passphrase handling
- Error handling provides clear, non-revealing error messages
- Performance impact minimal for crypto API operations
- Documentation complete and accurate

## Verification

- [ ] API specification designed and documented
- [ ] Crypto routes module implemented with all endpoints
- [ ] Random key initialization endpoint working
- [ ] Passphrase-based initialization endpoint working
- [ ] Status and validation endpoints implemented
- [ ] Proper security headers and passphrase handling
- [ ] Comprehensive error handling with appropriate HTTP status codes
- [ ] Unit tests covering all crypto API endpoints
- [ ] Integration tests validating complete workflows
- [ ] Security tests confirming safe operation
- [ ] Documentation updated with API examples

## Files Modified

**New Files**:
- `src/datafold_node/crypto_routes.rs` - HTTP API endpoints for crypto initialization

**Modified Files**:
- `src/datafold_node/mod.rs` - Module exports for crypto routes
- `src/datafold_node/http_server.rs` - Integration of crypto routes

**Test Files**:
- `tests/crypto_api_test.rs` - Comprehensive API endpoint testing
- `tests/integration/crypto_api_workflow_test.rs` - End-to-end API workflow testing

**Documentation**:
- API documentation for crypto initialization endpoints
- Security guidelines for crypto API usage