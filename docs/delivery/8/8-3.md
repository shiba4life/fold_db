# [8-3] Implement Argon2id passphrase-based key derivation

[Back to task list](./tasks.md)

## Description

Implement secure passphrase-based key derivation using Argon2id for generating Ed25519 master keys from user passphrases. This will enable users to initialize DataFold databases with encrypted storage using memorable passphrases while maintaining cryptographic security through proper key derivation.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2024-12-30 14:30:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2024-12-30 14:31:00 | Status Update | Proposed | Agreed | Task approved for implementation | tomtang |
| 2024-12-30 14:32:00 | Status Update | Agreed | InProgress | Started Argon2 implementation work | AI Agent |
| 2024-12-30 15:00:00 | Status Update | InProgress | Review | Completed Argon2id implementation and testing | AI Agent |

## Requirements

1. **Argon2id Implementation**: Use Argon2id for secure passphrase-based key derivation
2. **Salt Generation**: Implement secure salt generation and management
3. **Parameter Configuration**: Define secure Argon2 parameters (memory, time, parallelism)
4. **Integration with Ed25519**: Generate Ed25519 keys from derived key material
5. **Error Handling**: Comprehensive error handling for derivation failures
6. **Security Best Practices**: Follow recommendations from OWASP and security guides

## Implementation Plan

1. **Create Argon2 Module**:
   - Create `src/crypto/argon2.rs` for key derivation operations
   - Add Argon2id parameter configuration
   - Implement salt generation utilities

2. **Key Derivation Functions**:
   - Implement passphrase-to-seed derivation using Argon2id
   - Generate salts using cryptographically secure random number generation
   - Provide configurable security parameters

3. **Integration with Ed25519**:
   - Use derived seeds to generate Ed25519 master key pairs
   - Ensure derived keys have sufficient entropy
   - Implement seed-to-keypair conversion

4. **Parameter Management**:
   - Define secure default parameters for different use cases
   - Support custom parameter configuration
   - Document security trade-offs

5. **Testing and Validation**:
   - Unit tests for key derivation consistency
   - Test parameter validation
   - Verify integration with Ed25519 key generation

## Test Plan

**Objective**: Verify that Argon2id key derivation produces secure, consistent results and integrates properly with Ed25519 key generation.

**Test Scope**: Key derivation, salt generation, parameter validation, and Ed25519 integration.

**Key Test Scenarios**:
- Same passphrase + salt produces identical derived keys
- Different salts produce different derived keys
- Parameter validation rejects invalid configurations
- Derived seeds successfully generate Ed25519 keys
- Error cases are handled gracefully
- Performance meets acceptable thresholds

**Success Criteria**:
- Key derivation is deterministic with same inputs
- Salt generation is cryptographically secure
- Parameter validation enforces security requirements
- Ed25519 integration works seamlessly
- All error conditions are properly handled
- Performance is acceptable for user experience

## Verification

- [x] Argon2id key derivation functions implemented
- [x] Secure salt generation utilities created
- [x] Parameter configuration and validation added
- [x] Integration with Ed25519 key generation working
- [x] Comprehensive error handling implemented
- [x] Unit tests cover all derivation scenarios
- [x] Performance benchmarks meet requirements
- [x] Security parameters follow best practices

## Files Modified

**New Files**:
- `src/crypto/argon2.rs` - Argon2id key derivation implementation

**Modified Files**:
- `src/crypto/mod.rs` - Export Argon2 functionality
- `src/crypto/ed25519.rs` - Integration points for derived keys (if needed) 