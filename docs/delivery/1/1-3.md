# [1-3] Update convert_field to handle Collection field type

[Back to task list](./tasks.md)

## Description

Modify the convert_field function in `src/schema/core.rs` to create CollectionField instances from JSON schema definitions. Currently, the function has a TODO comment and creates all fields as Single fields regardless of the field_type specified in the JSON.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-19 12:07:00 | Created | N/A | Proposed | Task file created | User |

## Requirements

1. Update `convert_field` function to check the `field_type` from JSON schema
2. Create appropriate field variant based on the field type
3. Handle Collection field type to create `CollectionField` instances
4. Ensure backward compatibility with existing schemas

## Implementation Plan

1. **Locate convert_field function** (around line 1520)

2. **Update the function to check field_type**:
   ```rust
   fn convert_field(json_field: JsonSchemaField) -> FieldVariant {
       let permission_policy = json_field.permission_policy.into();
       let payment_config = json_field.payment_config.into();
       let field_mappers = json_field.field_mappers;
       
       match json_field.field_type {
           FieldType::Single => {
               let mut single_field = SingleField::new(
                   permission_policy,
                   payment_config,
                   field_mappers,
               );
               if let Some(ref_atom_uuid) = json_field.ref_atom_uuid {
                   single_field.set_ref_atom_uuid(ref_atom_uuid);
               }
               if let Some(json_transform) = json_field.transform {
                   single_field.set_transform(json_transform.into());
               }
               FieldVariant::Single(single_field)
           }
           FieldType::Collection => {
               let mut collection_field = CollectionField::new(
                   permission_policy,
                   payment_config,
                   field_mappers,
               );
               if let Some(ref_atom_uuid) = json_field.ref_atom_uuid {
                   collection_field.set_ref_atom_uuid(ref_atom_uuid);
               }
               if let Some(json_transform) = json_field.transform {
                   collection_field.set_transform(json_transform.into());
               }
               FieldVariant::Collection(collection_field)
           }
           FieldType::Range => {
               let mut range_field = RangeField::new(
                   permission_policy,
                   payment_config,
                   field_mappers,
               );
               if let Some(ref_atom_uuid) = json_field.ref_atom_uuid {
                   range_field.set_ref_atom_uuid(ref_atom_uuid);
               }
               if let Some(json_transform) = json_field.transform {
                   range_field.set_transform(json_transform.into());
               }
               FieldVariant::Range(range_field)
           }
       }
   }
   ```

3. **Add necessary imports** for CollectionField

4. **Update field factory** if needed to support collection field creation

## Test Plan

1. **Unit Tests**:
   - Test convert_field with JSON containing collection field type
   - Verify CollectionField is created with correct properties
   - Test all three field types (Single, Collection, Range)

2. **JSON Schema Tests**:
   - Create test JSON schemas with collection fields
   - Verify they are interpreted correctly

3. **Backward Compatibility Tests**:
   - Ensure existing schemas without explicit field_type still work
   - Test schemas with missing field_type default to Single

## Verification

- [ ] convert_field handles all three field types
- [ ] CollectionField instances are created for collection field type
- [ ] Field properties are correctly transferred from JSON
- [ ] Transform and ref_atom_uuid are properly set
- [ ] Unit tests pass
- [ ] Backward compatibility maintained

## Files Modified

- `src/schema/core.rs`
- `src/schema/field_factory.rs` (if collection factory methods needed)