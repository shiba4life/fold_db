# [1-4] Add unit tests for collection atom ref creation

[Back to task list](./tasks.md)

## Description

Create comprehensive unit tests to verify that collection atom refs are properly created when schemas with collection fields are approved. These tests should cover the map_fields function, convert_field function, and the overall schema approval process for collection fields.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-19 12:08:00 | Created | N/A | Proposed | Task file created | User |

## Requirements

1. Test collection field creation from JSON schema
2. Test atom ref creation during schema approval
3. Test database persistence of collection atom refs
4. Test error handling scenarios
5. Test mixed schemas with different field types

## Implementation Plan

1. **Create test file** `src/schema/collection_field_tests.rs`

2. **Test collection field creation**:
   ```rust
   #[test]
   fn test_collection_field_creation() {
       let collection_field = CollectionField::new(
           PermissionsPolicy::default(),
           FieldPaymentConfig::default(),
           HashMap::new(),
       );
       assert!(collection_field.ref_atom_uuid().is_none());
   }
   ```

3. **Test convert_field with collection type**:
   ```rust
   #[test]
   fn test_convert_field_collection() {
       let json_field = JsonSchemaField {
           field_type: FieldType::Collection,
           permission_policy: JsonPermissionPolicy::default(),
           payment_config: JsonFieldPaymentConfig::default(),
           field_mappers: HashMap::new(),
           ref_atom_uuid: None,
           transform: None,
           writable: true,
       };
       
       match SchemaCore::convert_field(json_field) {
           FieldVariant::Collection(_) => (),
           _ => panic!("Expected Collection variant"),
       }
   }
   ```

4. **Test map_fields with collection fields**:
   ```rust
   #[test]
   fn test_map_fields_creates_collection_atom_refs() {
       let temp_dir = tempdir().unwrap();
       let schema_core = SchemaCore::new(
           temp_dir.path().to_str().unwrap(),
           db_ops,
           message_bus,
       ).unwrap();
       
       // Create schema with collection field
       let mut schema = Schema::new("TestSchema");
       schema.fields.insert(
           "tags".to_string(),
           FieldVariant::Collection(CollectionField::new(...)),
       );
       
       // Add schema and approve it
       schema_core.add_schema_available(schema).unwrap();
       schema_core.approve_schema("TestSchema").unwrap();
       
       // Verify atom ref was created
       let approved_schema = schema_core.get_schema("TestSchema").unwrap().unwrap();
       let tags_field = &approved_schema.fields["tags"];
       assert!(tags_field.ref_atom_uuid().is_some());
       
       // Verify AtomRefCollection exists in database
       let ref_uuid = tags_field.ref_atom_uuid().unwrap();
       let stored_ref = db_ops.get_item::<AtomRefCollection>(
           &format!("ref:{}", ref_uuid)
       ).unwrap();
       assert!(stored_ref.is_some());
   }
   ```

5. **Test mixed schema approval**:
   ```rust
   #[test]
   fn test_mixed_field_types_approval() {
       // Test schema with Single, Collection, and Range fields
   }
   ```

6. **Test error scenarios**:
   ```rust
   #[test]
   fn test_collection_atom_ref_creation_error_handling() {
       // Test database errors during atom ref creation
   }
   ```

## Test Plan

1. **Unit Test Coverage**:
   - CollectionField struct creation and methods
   - FieldVariant::Collection handling
   - convert_field function with collection type
   - map_fields creates collection atom refs
   - Schema approval with collection fields
   - Error handling and edge cases

2. **Integration with Existing Tests**:
   - Update existing schema tests to include collection fields
   - Ensure no regression in existing functionality

## Verification

- [ ] All new unit tests pass
- [ ] Existing tests still pass
- [ ] Test coverage includes all new code paths
- [ ] Error scenarios are properly tested
- [ ] Database operations are verified

## Files Modified

- `src/schema/collection_field_tests.rs` (new file)
- `src/schema/mod.rs` (to include test module)
- `src/schema/core.rs` (if tests need friend access)