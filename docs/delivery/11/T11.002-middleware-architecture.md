# T11.002 – Signature Verification Middleware Architecture Design

## 1. Introduction & Scope

This document defines the architecture for a signature verification middleware to be integrated into DataFold’s HTTP server. The middleware will enforce RFC 9421-compliant Ed25519 HTTP message signatures, provide replay prevention, and integrate with DataFold’s crypto and permissions systems. The design assumes a single-instance deployment with in-memory nonce storage, but documents extension points for Redis-based distributed nonce storage.

## 2. High-Level Architecture Overview

The middleware acts as an Actix-web middleware component, intercepting incoming HTTP requests to:
- Extract and validate signature headers
- Verify Ed25519 signatures using the `ed25519-dalek` crate
- Enforce timestamp and nonce-based replay prevention
- Log security events and errors
- Pass authenticated requests to the permissions system and application logic

## 3. Component Structure

### 3.1 Signature Extraction & Validation
- Parses `Signature-Input` and `Signature` headers per RFC 9421
- Validates required parameters: `created`, `keyid`, `alg`, `nonce`
- Ensures minimum signature coverage: `@method`, `@target-uri`, `content-type`, `content-digest`

### 3.2 Ed25519 Verification
- Uses `ed25519-dalek` via DataFold’s crypto module
- Looks up public key by `keyid` (multi-tenant ready)
- Verifies signature over canonicalized message

### 3.3 Timestamp & Nonce Validation
- Checks `created` timestamp is within allowed window (default: 300s)
- Checks nonce is unused in in-memory store (HashSet with TTL)
- Stores nonce with expiration on successful validation

#### Extension Point: Redis
- Replace in-memory store with Redis for distributed deployments
- Use Redis `SETNX` and key expiration for atomicity and TTL

### 3.4 Error Handling & Security Logging
- Uses `FoldDbError` for error propagation
- Logs security events (invalid signature, replay, etc.) via audit logger
- Returns RFC 9421-compliant error responses

## 4. Integration Points

- **HTTP Server:** Registered as Actix-web middleware in [`src/datafold_node/http_server.rs`](src/datafold_node/http_server.rs)
- **Crypto Module:** Uses Ed25519 verification from [`src/crypto/ed25519.rs`](src/crypto/ed25519.rs)
- **Permissions System:** Passes authenticated requests to permission checks in [`src/permissions/`](src/permissions/)
- **Error Handling:** Integrates with DataFold’s error and logging infrastructure

## 5. Data Flow & Diagrams

### 5.1 Request Processing Pipeline

```mermaid
flowchart TD
    A[Incoming HTTP Request] --> B{Signature Headers Present?}
    B -- No --> Z[Reject: Missing Signature]
    B -- Yes --> C[Extract Signature, Timestamp, Nonce]
    C --> D[Check Timestamp Validity]
    D -- Invalid --> Z1[Reject: Expired/Invalid Timestamp]
    D -- Valid --> E[Check Nonce in In-Memory Store]
    E -- Replayed --> Z2[Reject: Replay Detected]
    E -- New --> F[Verify Signature (ed25519-dalek)]
    F -- Invalid --> Z3[Reject: Invalid Signature]
    F -- Valid --> G[Store Nonce with TTL]
    G --> H[Pass to Permissions Middleware]
    H --> I[Continue Request Processing]
```

### 5.2 Error Handling & Security Logging

- All failures (missing/invalid signature, expired timestamp, replay, verification failure) are logged as security events.
- Errors are returned with appropriate HTTP status and RFC 9421 error details.

## 6. Configuration Management

### 6.1 Signature Validation Settings
- Allowed time window (default: 300s)
- Required signature fields
- Key lookup strategy

### 6.2 Replay Prevention Settings
- Nonce TTL (default: 300s)
- In-memory store (default), extensible to Redis

### 6.3 Example `NodeConfig` Extension

```rust
pub struct SignatureVerificationConfig {
    pub enabled: bool,
    pub allowed_time_window_secs: u64,
    pub nonce_ttl_secs: u64,
    // pub redis_url: Option<String>, // for future distributed support
}
```

## 7. Performance & Security Considerations

- **Performance:**  
  - Target <1ms overhead per request (in-memory nonce store, efficient Ed25519 verification)
  - Minimal allocations and fast path for valid requests
- **Security:**  
  - Strict RFC 9421 compliance
  - Deterministic signature verification
  - Replay prevention via timestamp+nonce
  - Audit logging for all failures

## 8. Implementation Roadmap

1. Implement Actix-web middleware skeleton
2. Integrate signature extraction and validation logic
3. Add Ed25519 verification using crypto module
4. Implement in-memory nonce store with TTL
5. Integrate error handling and security logging
6. Add configuration options to `NodeConfig`
7. Document extension points for Redis and distributed deployments
8. Write tests for all validation and error paths