# DataFold End-to-End Integration Test Suite

This directory contains the comprehensive end-to-end integration test suite for DataFold's message signing authentication system. The test suite validates the complete authentication workflow across the Rust server and all client implementations (JavaScript SDK, Python SDK, CLI tool).

## Overview

The E2E test suite provides comprehensive validation of:

- **Complete Authentication Workflows**: Key generation â†’ registration â†’ API access
- **Cross-Platform Integration**: JavaScript â†” Python â†” CLI â†” Server interoperability 
- **Real-World Scenarios**: Concurrent clients, network failures, time synchronization
- **Security Integration**: Replay prevention, attack detection, rate limiting

## Test Categories

### 1. Workflow Tests (`workflow_tests.rs`)

Tests complete end-to-end authentication workflows:

- **Basic E2E Workflow**: Key generation through authenticated API access
- **Multi-Client Workflow**: Multiple concurrent client authentication
- **Key Rotation Workflow**: Key replacement and transition scenarios
- **Error Handling Workflow**: Recovery from authentication failures
- **Session Lifecycle**: Long-running session management

### 2. Cross-Platform Tests (`cross_platform_tests.rs`)

Validates interoperability between different client implementations:

- **JavaScript SDK Integration**: Request signing and server verification
- **Python SDK Integration**: Cross-platform signature compatibility
- **CLI Tool Integration**: Command-line authentication workflows
- **Cross-Platform Verification**: Signatures generated by one platform verified by others
- **Message Canonicalization**: Consistent message formatting across platforms

### 3. Real-World Scenarios (`real_world_scenarios.rs`)

Tests system behavior under realistic conditions:

- **Concurrent Authentication**: High-concurrency client scenarios
- **High-Load Testing**: Sustained and burst load validation
- **Network Failure Recovery**: Resilience and retry mechanisms
- **Time Synchronization**: Clock skew and timezone handling
- **Long-Running Sessions**: Extended authentication sessions
- **Mixed Traffic**: Authenticated and unauthenticated request handling

### 4. Security Integration Tests (`security_integration_tests.rs`)

Validates security mechanisms and attack prevention:

- **Replay Attack Prevention**: Nonce-based replay protection
- **Invalid Signature Rejection**: Malformed and corrupt signature handling
- **Timestamp Window Enforcement**: Time-based request validation
- **Rate Limiting**: Request throttling and abuse prevention
- **Attack Pattern Recognition**: Brute force and enumeration detection

## Quick Start

### Prerequisites

- **Rust**: Latest stable version with Cargo
- **Node.js & npm**: For JavaScript SDK tests (optional)
- **Python & pip**: For Python SDK tests (optional)
- **DataFold Server**: Running on localhost:8080 (or configured URL)

### Running Tests

```bash
# Run quick E2E tests (suitable for CI/CD)
./scripts/run_e2e_tests.sh --type quick

# Run comprehensive test suite
./scripts/run_e2e_tests.sh --type comprehensive --attack-sim

# Setup environments and run full suite
./scripts/run_e2e_tests.sh --setup-sdks --start-server --type comprehensive --stop-server
```

### Manual Test Execution

```bash
# Run individual test suites
cargo test --test e2e_integration_test test_e2e_integration_suite_quick -- --ignored
cargo test --test e2e_integration_test test_e2e_integration_suite_comprehensive -- --ignored

# Run specific test categories
cargo test workflow_tests
cargo test cross_platform_tests
cargo test real_world_scenarios
cargo test security_integration_tests
```

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `E2E_SERVER_URL` | DataFold server URL | `http://localhost:8080` |
| `E2E_TIMEOUT_SECS` | Test timeout in seconds | `60` |
| `E2E_CONCURRENT_CLIENTS` | Number of concurrent test clients | `10` |
| `E2E_ENABLE_ATTACK_SIM` | Enable attack simulation tests | `false` |
| `E2E_GENERATE_REPORTS` | Generate test reports | `true` |

### Test Configuration

```rust
use datafold::tests::e2e::test_utils::E2ETestConfig;

let config = E2ETestConfig {
    server_url: "http://localhost:8080".to_string(),
    test_timeout_secs: 60,
    concurrent_clients: 10,
    enable_attack_simulation: false,
    temp_dir: std::env::temp_dir(),
};
```

## Test Architecture

### Core Components

```
tests/e2e/
â”œâ”€â”€ mod.rs                          # Main module exports
â”œâ”€â”€ main_test_runner.rs             # Orchestrates all test suites
â”œâ”€â”€ test_utils.rs                   # Common utilities and fixtures
â”œâ”€â”€ server_harness.rs               # Test server management
â”œâ”€â”€ sdk_harness.rs                  # SDK environment management
â”œâ”€â”€ workflow_tests.rs               # Complete workflow validation
â”œâ”€â”€ cross_platform_tests.rs         # Interoperability testing
â”œâ”€â”€ real_world_scenarios.rs         # Load and resilience testing
â””â”€â”€ security_integration_tests.rs   # Security validation
```

### Key Utilities

#### Test Credentials
```rust
let credentials = TestCredentials::generate()?;
// Generates Ed25519 keypair, client ID, key ID, etc.
```

#### HTTP Client
```rust
let client = E2EHttpClient::new("http://localhost:8080".to_string())
    .with_credentials(credentials);
let response = client.authenticated_request("POST", "/api/test", body).await?;
```

#### Test Server
```rust
let mut server = TestServerHarness::new(SecurityProfile::Standard).await?;
server.start().await?;
// Provides isolated test server instance
```

#### SDK Harnesses
```rust
let mut js_harness = JavaScriptSDKHarness::new(&config).await?;
js_harness.setup().await?;
let signature = js_harness.sign_request(&credentials, &request).await?;
```

## Test Scenarios

### Example: Basic Authentication Flow

```rust
#[tokio::test]
async fn test_basic_authentication_flow() {
    // 1. Start test server
    let mut server = TestServerHarness::new(SecurityProfile::Standard).await?;
    server.start().await?;

    // 2. Generate credentials
    let credentials = TestCredentials::generate()?;
    
    // 3. Register public key
    let mut client = E2EHttpClient::new(server.base_url().to_string());
    let registration_id = client.register_public_key(&credentials).await?;
    
    // 4. Make authenticated request
    let response = client.authenticated_request(
        "POST", 
        "/api/test", 
        Some(json!({"test": "data"}))
    ).await?;
    
    assert!(response.status().is_success());
}
```

### Example: Cross-Platform Verification

```rust
#[tokio::test]
async fn test_cross_platform_signatures() {
    // Generate signature with JavaScript SDK
    let js_signature = js_harness.sign_request(&credentials, &request).await?;
    
    // Verify with Python SDK
    let is_valid = python_harness.verify_signature(&credentials, &request, &js_signature).await?;
    assert!(is_valid);
    
    // Verify with server
    let server_result = server_client.verify_signature(&js_signature).await?;
    assert!(server_result);
}
```

## Performance Metrics

The test suite collects comprehensive performance metrics:

- **Signature Generation Time**: Time to create Ed25519 signatures
- **Signature Verification Time**: Time to validate signatures
- **Request Processing Time**: End-to-end API request latency
- **Throughput**: Requests per second under load
- **Success Rates**: Percentage of successful operations
- **Error Rates**: Failed authentication attempts

Example metrics output:
```
âœ… E2E Test Suite Complete: 47/50 tests passed (94.0% success)
ðŸ“Š Performance Metrics:
  Signature Generation: 2.3ms avg
  Signature Verification: 1.8ms avg  
  API Request Latency: 45ms avg
  Peak Throughput: 850 req/sec
  Concurrent Client Success Rate: 96.2%
```

## Reporting

### Test Reports

The test suite generates multiple report formats:

- **JSON Report**: Detailed results and metrics
- **JUnit XML**: CI/CD integration
- **HTML Report**: Visual test results (with coverage)

```bash
# Reports generated in test_reports/e2e/
test_reports/e2e/
â”œâ”€â”€ junit.xml              # CI/CD integration
â”œâ”€â”€ test_results.json      # Detailed results
â””â”€â”€ coverage/              # Coverage reports
```

### Example JSON Report
```json
{
  "test_run_summary": {
    "timestamp": 1698765432,
    "total_tests": 50,
    "passed_tests": 47,
    "success_rate": 0.94,
    "overall_status": "PASSED"
  },
  "performance_metrics": {
    "signature_generation_ms": 2.3,
    "api_request_latency_ms": 45.2,
    "concurrent_success_rate": 0.962
  }
}
```

## CI/CD Integration

### GitHub Actions Example

```yaml
name: E2E Integration Tests
on: [push, pull_request]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      
      - name: Start DataFold Server
        run: |
          cargo build --bin datafold_http_server
          cargo run --bin datafold_http_server &
          sleep 10
      
      - name: Run E2E Tests
        run: ./scripts/run_e2e_tests.sh --type quick
        env:
          E2E_SERVER_URL: http://localhost:8080
          E2E_TIMEOUT_SECS: 120
      
      - name: Upload Test Reports
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-reports
          path: test_reports/e2e/
```

## Troubleshooting

### Common Issues

**Server Connection Failed**
```bash
# Check server is running
curl http://localhost:8080/api/system/status

# Start server manually
cargo run --bin datafold_http_server
```

**SDK Environment Issues**
```bash
# Setup JavaScript SDK
cd js-sdk && npm install

# Setup Python SDK  
cd python-sdk && pip install -r requirements-dev.txt
```

**Test Timeouts**
```bash
# Increase timeout
E2E_TIMEOUT_SECS=120 ./scripts/run_e2e_tests.sh --type quick
```

### Debug Mode

```bash
# Enable debug logging
RUST_LOG=debug cargo test --test e2e_integration_test -- --ignored

# Run single test with full output
cargo test --test e2e_integration_test test_e2e_integration_suite_quick -- --ignored --nocapture
```

## Development

### Adding New Tests

1. **Create Test Module**: Add new test file in `tests/e2e/`
2. **Update Module Exports**: Add to `tests/e2e/mod.rs`
3. **Implement Test Suite**: Follow existing patterns
4. **Add to Main Runner**: Include in `main_test_runner.rs`

### Test Utilities

The `test_utils.rs` module provides:
- **Credential Generation**: `TestCredentials::generate()`
- **HTTP Client**: `E2EHttpClient` with authentication
- **Test Scenarios**: `TestScenario` builder pattern
- **Utilities**: Timestamps, nonces, test data generation

### Contributing

1. Follow existing test patterns and naming conventions
2. Add comprehensive error handling and logging
3. Include performance metrics collection
4. Update documentation for new test categories
5. Ensure tests are idempotent and can run concurrently

## Security Considerations

The test suite includes security-focused testing:

- **Credential Isolation**: Each test uses unique credentials
- **Attack Simulation**: Controlled security testing (disabled by default)
- **Rate Limiting**: Tests respect server rate limits
- **Cleanup**: Proper cleanup of test artifacts and credentials

**Note**: Attack simulation tests are disabled by default. Enable with `--attack-sim` flag only in secure test environments.

## Support

For issues with the E2E test suite:

1. Check the troubleshooting section above
2. Review test logs with debug output enabled
3. Verify server and SDK environment setup
4. Check GitHub issues for known problems

The E2E test suite is designed to provide comprehensive validation of DataFold's message signing authentication system across all supported platforms and use cases.